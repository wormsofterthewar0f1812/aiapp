<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PWA Text Editor</title>

<link rel="manifest" href="manifest.json">

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
:root {
    --bg-dark:#1e1e1e;
    --text-dark:#d4d4d4;
    --accent:#007acc;
    --sidebar-bg:#252526;
}

body {
    margin:0;
    height:100vh;
    display:flex;
    flex-direction:column;
    background:var(--bg-dark);
    color:var(--text-dark);
    font-family:sans-serif;
}

header {
    padding:10px 20px;
    background:var(--sidebar-bg);
    display:flex;
    justify-content:space-between;
    align-items:center;
    border-bottom:1px solid #333;
}

button {
    margin-left:8px;
    padding:6px 10px;
    border:none;
    border-radius:4px;
    background:var(--accent);
    color:white;
    cursor:pointer;
}

#main-container {
    flex:1;
    display:flex;
    overflow:hidden;
}

#sidebar {
    width:260px;
    background:var(--sidebar-bg);
    padding:10px;
    overflow-y:auto;
}

#note-list {
    list-style:none;
    padding:0;
    margin:0;
}

#note-list li {
    padding:8px;
    cursor:pointer;
}

#note-list li.active {
    background:#37373d;
}

main {
    flex:1;
    display:flex;
    flex-direction:column;
}

#title-container {
    padding:10px;
    border-bottom:1px solid #333;
}

#note-title {
    width:100%;
    background:none;
    border:none;
    color:inherit;
    font-size:1.4em;
    outline:none;
}

/* Editor + line numbers */
#editor-wrapper {
    flex:1;
    display:flex;
    overflow:hidden;
    font-family:monospace;
}

#line-numbers {
    padding:20px 10px;
    background:#1b1b1b;
    color:#777;
    text-align:right;
    user-select:none;
    border-right:1px solid #333;
    line-height:1.6;
}

#editor {
    flex:1;
    padding:20px;
    border:none;
    outline:none;
    resize:none;
    overflow:auto;

    white-space:pre-wrap;
    word-wrap:break-word;
    overflow-wrap:break-word;

    background:var(--bg-dark);
    color:var(--text-dark);
}

#preview-container {
    display:none;
    padding:20px;
    overflow-y:auto;
}
</style>
</head>

<body>
<header>
    <div>
        <span>PWA Editor</span>
        <span id="stats">0 chars · 0 words</span>
    </div>
    <div>
        <button id="new-btn">New</button>
        <button id="preview-btn">Preview</button>
        <button id="export-btn">Export</button>
    </div>
</header>

<div id="main-container">
    <aside id="sidebar">
        <ul id="note-list"></ul>
    </aside>

    <main>
        <div id="title-container">
            <input id="note-title" placeholder="Untitled Note">
        </div>

        <div id="editor-wrapper">
            <div id="line-numbers"></div>
            <textarea id="editor" placeholder="Start typing…"></textarea>
        </div>

        <div id="preview-container"></div>
    </main>
</div>

<script>
/* ===============================
   Service Worker registration
================================ */
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
}

/* ===============================
   Editor logic
================================ */
const editor = document.getElementById('editor');
const lineNumbers = document.getElementById('line-numbers');
const preview = document.getElementById('preview-container');
const noteTitle = document.getElementById('note-title');
const noteList = document.getElementById('note-list');
const stats = document.getElementById('stats');

let notes = JSON.parse(localStorage.getItem('notes')) || [];
let currentId = null;
let previewMode = false;

function updateLineNumbers() {
    const count = editor.value.split('\n').length;
    lineNumbers.innerHTML = Array.from(
        { length: count },
        (_, i) => i + 1
    ).join('<br>');
}

function updateStats() {
    const text = editor.value;
    const words = text.trim() ? text.trim().split(/\s+/).length : 0;
    stats.textContent = `${text.length} chars · ${words} words`;
}

function save() {
    if (!currentId) return;
    const n = notes.find(n => n.id === currentId);
    n.title = noteTitle.value || 'Untitled';
    n.content = editor.value;
    localStorage.setItem('notes', JSON.stringify(notes));
    renderList();
}

function renderList() {
    noteList.innerHTML = '';
    notes.forEach(n => {
        const li = document.createElement('li');
        li.textContent = n.title;
        li.className = n.id === currentId ? 'active' : '';
        li.onclick = () => load(n);
        noteList.appendChild(li);
    });
}

function load(note) {
    currentId = note.id;
    noteTitle.value = note.title;
    editor.value = note.content;
    updateLineNumbers();
    updateStats();
    renderList();
}

function createNote() {
    const n = { id: Date.now(), title:'Untitled', content:'' };
    notes.push(n);
    load(n);
    save();
}

editor.addEventListener('input', () => {
    updateLineNumbers();
    updateStats();
    save();
});

editor.addEventListener('scroll', () => {
    lineNumbers.scrollTop = editor.scrollTop;
});

document.getElementById('new-btn').onclick = createNote;

document.getElementById('preview-btn').onclick = () => {
    previewMode = !previewMode;
    document.getElementById('editor-wrapper').style.display = previewMode ? 'none' : 'flex';
    preview.style.display = previewMode ? 'block' : 'none';
    if (previewMode) preview.innerHTML = marked.parse(editor.value);
};

document.getElementById('export-btn').onclick = () => {
    const blob = new Blob([editor.value], { type:'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = (noteTitle.value || 'note') + '.txt';
    a.click();
};

/* Init */
if (notes.length === 0) createNote();
else load(notes[0]);
</script>
</body>
</html>
